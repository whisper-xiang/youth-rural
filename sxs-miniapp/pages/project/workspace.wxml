<view class="page">
  <!-- é¡¹ç›®å¤´éƒ¨ä¿¡æ¯ -->
  <view class="project-header">
    <view class="project-title">{{projectInfo.name}}</view>
    <view class="project-meta">
      <view class="project-role {{projectInfo.userRole}}">
        <text class="role-icon">{{projectInfo.userRole === 'leader' ? 'ğŸ‘‘' : 'ğŸ‘¥'}}</text>
        <text class="role-text">{{projectInfo.userRoleText}}</text>
      </view>
      <view class="project-status {{projectInfo.statusClass}}">
        <text class="status-icon">{{projectInfo.statusIcon}}</text>
        <text class="status-text">{{projectInfo.statusText}}</text>
      </view>
    </view>
  </view>

  <!-- Tab å¯¼èˆª -->
  <view class="tab-container">
    <view class="tab-list">
      <view 
        class="tab-item {{currentTab === index ? 'active' : ''}}" 
        wx:for="{{tabs}}" 
        wx:key="index"
        bindtap="switchTab"
        data-index="{{index}}"
      >
        <text class="tab-icon">{{item.icon}}</text>
        <text class="tab-name">{{item.name}}</text>
        <view class="tab-badge" wx:if="{{item.badge}}">{{item.badge}}</view>
      </view>
    </view>
  </view>

  <!-- Tab å†…å®¹åŒºåŸŸ -->
  <view class="content-container">
    <!-- é¡¹ç›®è¯¦æƒ… -->
    <view class="tab-content" wx:if="{{currentTab === 0}}">
      <view class="detail-section">
        <view class="section-title">é¡¹ç›®åŸºæœ¬ä¿¡æ¯</view>
        <view class="info-card">
          <view class="info-item">
            <text class="info-label">é¡¹ç›®åç§°</text>
            <text class="info-value">{{projectInfo.name}}</text>
          </view>
          <view class="info-item">
            <text class="info-label">é¡¹ç›®ç±»å‹</text>
            <text class="info-value">{{projectInfo.type}}</text>
          </view>
          <view class="info-item">
            <text class="info-label">åˆ›å»ºæ—¶é—´</text>
            <text class="info-value">{{projectInfo.createTime}}</text>
          </view>
          <view class="info-item">
            <text class="info-label">é¡¹ç›®å‘¨æœŸ</text>
            <text class="info-value">{{projectInfo.startDate}} è‡³ {{projectInfo.endDate}}</text>
          </view>
          <view class="info-item">
            <text class="info-label">é¡¹ç›®é¢„ç®—</text>
            <text class="info-value">Â¥{{projectInfo.budget}}</text>
          </view>
        </view>
      </view>

      <view class="detail-section">
        <view class="section-title">å›¢é˜Ÿæˆå‘˜</view>
        <view class="team-list">
          <view class="team-item" wx:for="{{projectInfo.team}}" wx:key="id">
            <view class="member-avatar">{{item.name.charAt(0)}}</view>
            <view class="member-info">
              <view class="member-name">{{item.name}}</view>
              <view class="member-role">{{item.role}}</view>
            </view>
            <view class="member-contact" wx:if="{{item.phone}}">
              <text class="contact-icon">ğŸ“±</text>
              <text class="contact-text">{{item.phone}}</text>
            </view>
          </view>
        </view>
      </view>

      <view class="detail-section">
        <view class="section-title">æŒ‡å¯¼è€å¸ˆ</view>
        <view class="teacher-info">
          <view class="teacher-avatar">{{projectInfo.teacher.name.charAt(0)}}</view>
          <view class="teacher-details">
            <view class="teacher-name">{{projectInfo.teacher.name}}</view>
            <view class="teacher-title">{{projectInfo.teacher.title}}</view>
            <view class="teacher-department">{{projectInfo.teacher.department}}</view>
          </view>
          <view class="teacher-contact" wx:if="{{projectInfo.teacher.email}}">
            <text class="contact-icon">ğŸ“§</text>
            <text class="contact-text">{{projectInfo.teacher.email}}</text>
          </view>
        </view>
      </view>

      <view class="detail-section">
        <view class="section-title">å®¡æ ¸æµç¨‹</view>
        <view class="timeline">
          <view class="timeline-item" wx:for="{{projectInfo.timeline}}" wx:key="index">
            <view class="timeline-dot {{item.status}}"></view>
            <view class="timeline-content">
              <view class="timeline-title">{{item.title}}</view>
              <view class="timeline-desc">{{item.description}}</view>
              <view class="timeline-time" wx:if="{{item.time}}">{{item.time}}</view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- è¿›åº¦è®°å½• -->
    <view class="tab-content" wx:if="{{currentTab === 1}}">
      <view class="progress-header">
        <view class="progress-title">é¡¹ç›®è¿›åº¦</view>
        <button class="add-progress-btn" bindtap="showAddProgress" wx:if="{{projectInfo.status !== 'closed'}}">
          <text class="btn-icon">â•</text>
          <text class="btn-text">æ·»åŠ è¿›åº¦</text>
        </button>
      </view>
      
      <view class="progress-list" wx:if="{{progressList.length > 0}}">
        <view class="progress-item" wx:for="{{progressList}}" wx:key="id">
          <view class="progress-header">
            <view class="progress-type-tag {{item.type}}">{{item.typeText}}</view>
            <view class="progress-date">{{item.date}}</view>
            <view class="progress-actions" wx:if="{{projectInfo.status !== 'closed'}}">
              <view class="action-btn edit" bindtap="editProgress" data-item="{{item}}">
                <text class="action-icon">âœï¸</text>
              </view>
            </view>
          </view>
          <view class="progress-content">
            <view class="progress-title">{{item.title}}</view>
            <view class="progress-desc">{{item.description}}</view>
            <view class="progress-files" wx:if="{{item.files && item.files.length > 0}}">
              <view 
                class="file-item" 
                wx:for="{{item.files}}" 
                wx:key="index" 
                wx:for-item="file"
                bindtap="onFileTap"
                data-file="{{file}}"
                data-files="{{item.files}}"
              >
                <text class="file-icon">{{file.type === 'image' ? 'ğŸ–¼ï¸' : file.type === 'video' ? 'ğŸ¥' : 'ğŸ“„'}}</text>
                <text class="file-name">{{file.name}}</text>
              </view>
            </view>
          </view>
          <view class="progress-author">by {{item.author}}</view>
        </view>
      </view>
      
      <view class="empty-progress" wx:else>
        <view class="empty-icon">ğŸ“</view>
        <view class="empty-title">æš‚æ— è¿›åº¦è®°å½•</view>
        <view class="empty-desc">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ ç¬¬ä¸€æ¡è¿›åº¦</view>
      </view>
    </view>

    <!-- æˆæœææ–™ -->
    <view class="tab-content" wx:if="{{currentTab === 2}}">
      <view class="result-header">
        <view class="result-title">æˆæœææ–™</view>
        <button class="upload-btn" bindtap="showUploadModal" wx:if="{{projectInfo.status !== 'closed'}}">
          <text class="btn-icon">ğŸ“¤</text>
          <text class="btn-text">ä¸Šä¼ æˆæœ</text>
        </button>
      </view>
      
      <block wx:if="{{hasResultFiles}}">
        <view class="result-categories">
          <!-- å›¾ç‰‡ -->
          <view class="category-section" wx:if="{{resultFiles.images.length > 0}}">
            <view class="category-title">
              <text class="category-icon">ğŸ–¼ï¸</text>
              <text class="category-name">å›¾ç‰‡ ({{resultFiles.images.length}})</text>
            </view>
            <view class="image-grid">
              <image 
                class="image-item" 
                wx:for="{{resultFiles.images}}" 
                wx:key="index"
                src="{{item.url}}"
                mode="aspectFill"
                bindtap="previewImage"
                data-url="{{item.url}}"
                data-urls="{{resultFiles.images}}"
              ></image>
            </view>
          </view>
          
          <!-- æ–‡æ¡£ -->
          <view class="category-section" wx:if="{{resultFiles.documents.length > 0}}">
            <view class="category-title">
              <text class="category-icon">ğŸ“„</text>
              <text class="category-name">æ–‡æ¡£ ({{resultFiles.documents.length}})</text>
            </view>
            <view class="document-list">
              <view class="document-item" wx:for="{{resultFiles.documents}}" wx:key="index">
                <text class="doc-icon">ğŸ“„</text>
                <text class="doc-name">{{item.name}}</text>
                <text class="doc-size">{{item.size}}</text>
                <view class="doc-actions">
                  <text class="action-btn" bindtap="downloadFile" data-url="{{item.url}}">ä¸‹è½½</text>
                  <text class="action-btn delete" bindtap="deleteFile" data-id="{{item.id}}" data-type="document" wx:if="{{projectInfo.status !== 'closed'}}">åˆ é™¤</text>
                </view>
              </view>
            </view>
          </view>
          
          <!-- è§†é¢‘ -->
          <view class="category-section" wx:if="{{resultFiles.videos.length > 0}}">
            <view class="category-title">
              <text class="category-icon">ğŸ¥</text>
              <text class="category-name">è§†é¢‘ ({{resultFiles.videos.length}})</text>
            </view>
            <view class="video-list">
              <view class="video-item" wx:for="{{resultFiles.videos}}" wx:key="index">
                <video class="video-player" src="{{item.url}}" controls></video>
                <view class="video-info">
                  <text class="video-name">{{item.name}}</text>
                  <text class="video-duration">{{item.duration}}</text>
                </view>
                <view class="video-actions">
                  <text class="action-btn delete" bindtap="deleteFile" data-id="{{item.id}}" data-type="video" wx:if="{{projectInfo.status !== 'closed'}}">åˆ é™¤</text>
                </view>
              </view>
            </view>
          </view>
        </view>
      </block>
      
      <view class="empty-result" wx:else>
        <view class="empty-icon">ğŸ“</view>
        <view class="empty-title">æš‚æ— æˆæœææ–™</view>
        <view class="empty-desc">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ä¸Šä¼ é¡¹ç›®æˆæœ</view>
      </view>
    </view>

    <!-- ç»“é¡¹ç”³è¯· -->
    <view class="tab-content" wx:if="{{currentTab === 3}}">
      <view class="closure-header">
        <view class="closure-title">ç»“é¡¹ç”³è¯·</view>
        <view class="closure-status" wx:if="{{closureInfo.status}}">
          <text class="status-text">{{projectInfo.status === 'closed' ? 'å·²ç»“é¡¹' : closureInfo.statusText}}</text>
        </view>
      </view>
      
      <view class="closure-form">
        <view class="form-section">
          <view class="form-title">é¡¹ç›®æ€»ç»“</view>
          <textarea 
            class="form-textarea" 
            placeholder="{{projectInfo.status === 'closed' ? '' : 'è¯·è¯¦ç»†æ€»ç»“é¡¹ç›®å®æ–½æƒ…å†µã€ä¸»è¦æˆæœã€åˆ›æ–°ç‚¹ç­‰...'}}"
            value="{{closureInfo.summary}}"
            bindinput="onSummaryInput"
            maxlength="2000"
            disabled="{{projectInfo.status === 'closed'}}"
          ></textarea>
          <view class="char-count" wx:if="{{projectInfo.status !== 'closed'}}">{{closureInfo.summary.length}}/2000</view>
        </view>
        
        <view class="form-section">
          <view class="form-title">æˆæœè¯´æ˜</view>
          <textarea 
            class="form-textarea" 
            placeholder="{{projectInfo.status === 'closed' ? '' : 'è¯·è¯´æ˜é¡¹ç›®å–å¾—çš„å…·ä½“æˆæœã€ç¤¾ä¼šå½±å“ã€å®è·µæ„ä¹‰ç­‰...'}}"
            value="{{closureInfo.achievements}}"
            bindinput="onAchievementsInput"
            maxlength="1500"
            disabled="{{projectInfo.status === 'closed'}}"
          ></textarea>
          <view class="char-count" wx:if="{{projectInfo.status !== 'closed'}}">{{closureInfo.achievements.length}}/1500</view>
        </view>
        
        <view class="form-section">
          <view class="form-title">ç¤¾ä¼šå½±å“</view>
          <textarea 
            class="form-textarea" 
            placeholder="{{projectInfo.status === 'closed' ? '' : 'è¯·æè¿°é¡¹ç›®äº§ç”Ÿçš„ç¤¾ä¼šå½±å“ã€åª’ä½“æŠ¥é“ã€è·å¥–æƒ…å†µç­‰...'}}"
            value="{{closureInfo.impact}}"
            bindinput="onImpactInput"
            maxlength="1000"
            disabled="{{projectInfo.status === 'closed'}}"
          ></textarea>
          <view class="char-count" wx:if="{{projectInfo.status !== 'closed'}}">{{closureInfo.impact.length}}/1000</view>
        </view>
        
        <view class="form-actions" wx:if="{{projectInfo.status !== 'closed'}}">
          <button class="submit-btn" bindtap="submitClosure" disabled="{{!canSubmit}}">æäº¤ç»“é¡¹ç”³è¯·</button>
        </view>
      </view>
    </view>

    <!-- è€å¸ˆåé¦ˆ -->
    <view class="tab-content" wx:if="{{currentTab === 4}}">
      <view class="feedback-header">
        <view class="feedback-title">è€å¸ˆåé¦ˆ</view>
        <view class="feedback-count" wx:if="{{feedbackList.length > 0}}">
          å…± {{feedbackList.length}} æ¡åé¦ˆ
        </view>
      </view>
      
      <view class="feedback-list" wx:if="{{feedbackList.length > 0}}">
        <view class="feedback-item" wx:for="{{feedbackList}}" wx:key="id">
          <view class="feedback-header-info">
            <view class="feedback-author">{{item.author}}</view>
            <view class="feedback-time">{{item.time}}</view>
            <view class="feedback-type {{item.type}}">{{item.typeText}}</view>
          </view>
          <view class="feedback-content">{{item.content}}</view>
          <view class="feedback-target" wx:if="{{item.target}}">
            <text class="target-label">é’ˆå¯¹ï¼š</text>
            <text class="target-text">{{item.target}}</text>
          </view>
        </view>
      </view>
      
      <view class="empty-feedback" wx:else>
        <view class="empty-icon">ğŸ’¬</view>
        <view class="empty-title">æš‚æ— è€å¸ˆåé¦ˆ</view>
        <view class="empty-desc">è€å¸ˆä¼šå¯¹æ‚¨çš„é¡¹ç›®è¿›åº¦å’Œæˆæœè¿›è¡ŒæŒ‡å¯¼</view>
      </view>
    </view>

    <!-- è¯„ä¼˜æƒ…å†µ -->
    <view class="tab-content" wx:if="{{currentTab === 5}}">
      <view class="evaluation-header">
        <view class="evaluation-title">è¯„ä¼˜æƒ…å†µ</view>
      </view>
      
      <view class="evaluation-card" wx:if="{{evaluationInfo && evaluationInfo.evaluation}}">
        <view class="excellent-badge" wx:if="{{projectInfo.is_excellent}}">
          ä¼˜ç§€é¡¹ç›®
        </view>
        
        <view class="eval-main">
          <view class="eval-label">å‚è¯„æ´»åŠ¨ï¼š{{evaluationInfo.evaluation.evaluation_title}}</view>
          <view class="eval-summary">
            <view class="eval-summary-item">
              <view class="eval-value score">{{evaluationInfo.evaluation.final_score || 'æš‚æ— è¯„åˆ†'}}</view>
              <view class="eval-label">æœ€ç»ˆå¾—åˆ†</view>
            </view>
            <view class="eval-summary-item" wx:if="{{evaluationInfo.evaluation.award_level}}">
              <view class="eval-value award">{{evaluationInfo.evaluation.award_level}}</view>
              <view class="eval-label">è·å¥–ç­‰çº§</view>
            </view>
          </view>
        </view>
        
        <view class="eval-details" wx:if="{{evaluationInfo.allScores && evaluationInfo.allScores.length > 0}}">
          <view class="section-subtitle">ä¸“å®¶è¯„å®¡æ„è§</view>
          <view class="expert-opinion-list">
            <view class="expert-opinion-item" wx:for="{{evaluationInfo.allScores}}" wx:key="index">
              <view class="expert-header">
                <text class="expert-name">ä¸“å®¶ {{index + 1}}</text>
                <text class="expert-score">{{item.total_score}}åˆ†</text>
              </view>
              <view class="expert-comment">{{item.comment || 'æœªå¡«å†™è¯„ä»·æ„è§'}}</view>
            </view>
          </view>
        </view>
      </view>
      
      <view class="empty-evaluation" wx:else>
        <view class="empty-eval-icon">ğŸ†</view>
        <view class="empty-eval-text">æš‚æœªå‚ä¸è¯„ä¼˜</view>
        <view class="empty-desc">é¡¹ç›®ç»“é¡¹åå°†ç”±ç®¡ç†å‘˜ç»Ÿä¸€å¼€å¯è¯„ä¼˜ç¯èŠ‚</view>
      </view>
    </view>
  </view>

  <!-- æ·»åŠ è¿›åº¦å¼¹çª— -->
  <view class="modal" wx:if="{{showAddProgressModal}}">
    <view class="modal-mask" bindtap="hideAddProgress"></view>
    <view class="modal-content">
      <view class="modal-header">
        <view class="modal-title">æ·»åŠ è¿›åº¦</view>
        <view class="modal-close" bindtap="hideAddProgress">Ã—</view>
      </view>
      <view class="modal-body">
        <view class="form-item">
          <view class="form-label">è¿›åº¦æ ‡é¢˜</view>
          <input 
            class="form-input" 
            placeholder="è¯·è¾“å…¥è¿›åº¦æ ‡é¢˜"
            value="{{newProgress.title}}"
            bindinput="onProgressTitleInput"
          />
        </view>
        <view class="form-item">
          <view class="form-label">è¿›åº¦æè¿°</view>
          <textarea 
            class="form-textarea" 
            placeholder="è¯·è¯¦ç»†æè¿°å½“å‰è¿›å±•æƒ…å†µ..."
            value="{{newProgress.description}}"
            bindinput="onProgressDescInput"
          ></textarea>
        </view>
        <view class="form-item">
          <view class="form-label">ä¸Šä¼ æ–‡ä»¶</view>
          <view class="upload-area" bindtap="chooseFiles">
            <text class="upload-icon">ğŸ“</text>
            <text class="upload-text">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</text>
          </view>
          <view class="file-list" wx:if="{{newProgress.files.length > 0}}">
            <view class="file-item" wx:for="{{newProgress.files}}" wx:key="index">
              <text class="file-name">{{item.name}}</text>
              <text class="file-remove" bindtap="removeFile" data-index="{{index}}">Ã—</text>
            </view>
          </view>
        </view>
      </view>
      <view class="modal-footer">
        <button class="cancel-btn" bindtap="hideAddProgress">å–æ¶ˆ</button>
        <button class="confirm-btn" bindtap="confirmAddProgress">ç¡®å®š</button>
      </view>
    </view>
  </view>

  <!-- ä¸Šä¼ æˆæœå¼¹çª— -->
  <view class="modal" wx:if="{{showUploadModal}}">
    <view class="modal-mask" bindtap="hideUploadModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <view class="modal-title">ä¸Šä¼ æˆæœ</view>
        <view class="modal-close" bindtap="hideUploadModal">Ã—</view>
      </view>
      <view class="modal-body">
        <view class="upload-types">
          <view class="upload-type" bindtap="chooseImage">
            <text class="type-icon">ğŸ–¼ï¸</text>
            <text class="type-name">ä¸Šä¼ å›¾ç‰‡</text>
          </view>
          <view class="upload-type" bindtap="chooseDocument">
            <text class="type-icon">ğŸ“„</text>
            <text class="type-name">ä¸Šä¼ æ–‡æ¡£</text>
          </view>
          <view class="upload-type" bindtap="chooseVideo">
            <text class="type-icon">ğŸ¥</text>
            <text class="type-name">ä¸Šä¼ è§†é¢‘</text>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>
