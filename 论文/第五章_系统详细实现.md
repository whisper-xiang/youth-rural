# 第五章 系统详细实现

## 5.1 系统开发与运行环境

### 5.1.1 开发环境

| 类别 | 工具/技术 | 版本 |
|------|----------|------|
| 操作系统 | macOS / Windows | - |
| 前端开发工具 | 微信开发者工具 | 1.06+ |
| 后端开发工具 | Visual Studio Code | 1.80+ |
| 数据库工具 | Navicat Premium | 16+ |
| 版本控制 | Git | 2.40+ |
| 接口测试 | Postman | 10+ |

### 5.1.2 运行环境

| 类别 | 技术/软件 | 版本要求 |
|------|----------|---------|
| 服务器 | Linux (CentOS/Ubuntu) | - |
| 运行时 | Node.js | >= 18.0 |
| 数据库 | MySQL | >= 5.7 |
| 包管理器 | npm | >= 9.0 |

### 5.1.3 技术栈

**前端技术栈：**
- 微信小程序原生框架
- WXML（页面结构）
- WXSS（页面样式）
- JavaScript ES6+（逻辑处理）

**后端技术栈：**
- Node.js（运行环境）
- Express（Web框架）
- mysql2（数据库驱动）
- jsonwebtoken（JWT认证）
- bcryptjs（密码加密）
- multer（文件上传）
- dotenv（环境变量）
- cors（跨域处理）

## 5.2 学生端功能实现

### 5.2.1 用户登录实现

用户登录是系统的入口功能，支持用户名密码登录和微信授权登录两种方式。

**（1）登录页面实现**

登录页面提供用户名和密码输入框，以及登录按钮。页面代码如下：

```xml
<!-- pages/login/index.wxml -->
<view class="login-container">
  <view class="login-header">
    <image class="logo" src="/images/logo.png"></image>
    <text class="title">三下乡活动管理系统</text>
  </view>
  
  <view class="login-form">
    <view class="form-item">
      <input placeholder="请输入用户名" bindinput="onUsernameInput" />
    </view>
    <view class="form-item">
      <input type="password" placeholder="请输入密码" bindinput="onPasswordInput" />
    </view>
    <button class="login-btn" bindtap="doLogin">登录</button>
  </view>
</view>
```

**（2）登录逻辑实现**

```javascript
// pages/login/index.js
const api = require('../../utils/api');

Page({
  data: {
    username: '',
    password: ''
  },

  onUsernameInput(e) {
    this.setData({ username: e.detail.value });
  },

  onPasswordInput(e) {
    this.setData({ password: e.detail.value });
  },

  async doLogin() {
    const { username, password } = this.data;
    
    if (!username || !password) {
      wx.showToast({ title: '请输入用户名和密码', icon: 'none' });
      return;
    }

    try {
      wx.showLoading({ title: '登录中...' });
      const res = await api.login({ username, password });
      
      // 保存Token和用户信息
      wx.setStorageSync('token', res.token);
      wx.setStorageSync('userInfo', res.userInfo);
      
      // 更新全局状态
      const app = getApp();
      app.globalData.token = res.token;
      app.globalData.userInfo = res.userInfo;
      
      wx.showToast({ title: '登录成功', icon: 'success' });
      wx.switchTab({ url: '/pages/index/index' });
    } catch (err) {
      wx.showToast({ title: err.message || '登录失败', icon: 'none' });
    } finally {
      wx.hideLoading();
    }
  }
});
```

**（3）后端登录接口实现**

```javascript
// routes/auth.js
router.post('/login', async (req, res) => {
  try {
    const { username, password } = req.body;
    
    if (!username || !password) {
      return error(res, '用户名和密码不能为空', 400);
    }

    // 查询用户
    const [users] = await db.query(
      'SELECT * FROM sys_user WHERE username = ? AND status = 1',
      [username]
    );

    if (users.length === 0) {
      return error(res, '用户名或密码错误', 400);
    }

    const user = users[0];

    // 验证密码
    const isMatch = await bcrypt.compare(password, user.password);
    if (!isMatch) {
      return error(res, '用户名或密码错误', 400);
    }

    // 生成Token
    const token = jwt.sign(
      { id: user.id, username: user.username, role: user.role },
      process.env.JWT_SECRET,
      { expiresIn: '7d' }
    );

    success(res, {
      token,
      userInfo: {
        id: user.id,
        username: user.username,
        name: user.real_name,
        role: user.role,
        collegeId: user.college_id
      }
    }, '登录成功');
  } catch (err) {
    console.error('Login error:', err);
    error(res, '登录失败', 500);
  }
});
```

### 5.2.2 项目申报实现

项目申报是学生端的核心功能，包括项目列表查看、项目创建、项目编辑和提交审批。

**（1）项目列表页面**

```javascript
// pages/activity/apply-list.js
const api = require('../../utils/api');

Page({
  data: {
    projects: [],
    page: 1,
    pageSize: 10,
    hasMore: true,
    loading: false
  },

  onLoad() {
    this.loadProjects();
  },

  async loadProjects() {
    if (this.data.loading || !this.data.hasMore) return;
    
    this.setData({ loading: true });
    
    try {
      const res = await api.getMyProjects({
        page: this.data.page,
        pageSize: this.data.pageSize
      });
      
      const newProjects = this.data.page === 1 
        ? res.list 
        : [...this.data.projects, ...res.list];
      
      this.setData({
        projects: newProjects,
        hasMore: res.list.length === this.data.pageSize,
        page: this.data.page + 1
      });
    } catch (err) {
      wx.showToast({ title: '加载失败', icon: 'none' });
    } finally {
      this.setData({ loading: false });
    }
  },

  onReachBottom() {
    this.loadProjects();
  },

  onPullDownRefresh() {
    this.setData({ page: 1, hasMore: true });
    this.loadProjects().then(() => {
      wx.stopPullDownRefresh();
    });
  },

  goToDetail(e) {
    const { id } = e.currentTarget.dataset;
    wx.navigateTo({ url: `/pages/activity/apply-detail?id=${id}` });
  },

  createProject() {
    wx.navigateTo({ url: '/pages/activity/apply-detail' });
  }
});
```

**（2）项目申报表单**

```javascript
// pages/activity/apply-detail.js
const api = require('../../utils/api');

Page({
  data: {
    id: null,
    isEdit: false,
    form: {
      title: '',
      category: '',
      description: '',
      targetArea: '',
      startDate: '',
      endDate: '',
      budget: '',
      teacherId: null
    },
    categories: ['乡村振兴', '支教助学', '红色文化', '科技支农', '医疗卫生', '法律援助'],
    teachers: [],
    members: []
  },

  onLoad(options) {
    if (options.id) {
      this.setData({ id: options.id, isEdit: true });
      this.loadDetail(options.id);
    }
    this.loadTeachers();
  },

  async loadDetail(id) {
    try {
      const res = await api.getProjectDetail(id);
      this.setData({
        form: {
          title: res.title,
          category: res.category,
          description: res.description,
          targetArea: res.target_area,
          startDate: res.start_date,
          endDate: res.end_date,
          budget: res.budget,
          teacherId: res.teacher_id
        },
        members: res.members || []
      });
    } catch (err) {
      wx.showToast({ title: '加载失败', icon: 'none' });
    }
  },

  async loadTeachers() {
    try {
      const res = await api.getTeachers();
      this.setData({ teachers: res });
    } catch (err) {
      console.error('Load teachers error:', err);
    }
  },

  // 保存草稿
  async saveDraft() {
    try {
      wx.showLoading({ title: '保存中...' });
      
      const data = { ...this.data.form, status: 'draft' };
      
      if (this.data.id) {
        await api.updateProject(this.data.id, data);
      } else {
        const res = await api.createProject(data);
        this.setData({ id: res.id });
      }
      
      wx.showToast({ title: '保存成功', icon: 'success' });
    } catch (err) {
      wx.showToast({ title: '保存失败', icon: 'none' });
    } finally {
      wx.hideLoading();
    }
  },

  // 提交申报
  async submitProject() {
    if (!this.validateForm()) return;
    
    try {
      wx.showLoading({ title: '提交中...' });
      
      const data = { ...this.data.form, status: 'pending' };
      
      if (this.data.id) {
        await api.updateProject(this.data.id, data);
      } else {
        await api.createProject(data);
      }
      
      wx.showToast({ title: '提交成功', icon: 'success' });
      setTimeout(() => {
        wx.navigateBack();
      }, 1500);
    } catch (err) {
      wx.showToast({ title: '提交失败', icon: 'none' });
    } finally {
      wx.hideLoading();
    }
  },

  validateForm() {
    const { title, category, description, teacherId } = this.data.form;
    
    if (!title) {
      wx.showToast({ title: '请输入项目名称', icon: 'none' });
      return false;
    }
    if (!category) {
      wx.showToast({ title: '请选择项目类别', icon: 'none' });
      return false;
    }
    if (!description) {
      wx.showToast({ title: '请输入项目描述', icon: 'none' });
      return false;
    }
    if (!teacherId) {
      wx.showToast({ title: '请选择指导教师', icon: 'none' });
      return false;
    }
    return true;
  }
});
```

### 5.2.3 进度上传实现

进度上传功能允许学生记录实践活动的进展情况，支持文字描述和图片上传。

**（1）进度上传页面**

```javascript
// pages/progress/detail.js
const api = require('../../utils/api');

Page({
  data: {
    projectId: null,
    form: {
      title: '',
      content: '',
      progressDate: '',
      location: ''
    },
    images: [],
    maxImages: 9
  },

  onLoad(options) {
    this.setData({ projectId: options.projectId });
  },

  // 选择图片
  chooseImage() {
    const remaining = this.data.maxImages - this.data.images.length;
    if (remaining <= 0) {
      wx.showToast({ title: '最多上传9张图片', icon: 'none' });
      return;
    }

    wx.chooseImage({
      count: remaining,
      sizeType: ['compressed'],
      sourceType: ['album', 'camera'],
      success: (res) => {
        this.setData({
          images: [...this.data.images, ...res.tempFilePaths]
        });
      }
    });
  },

  // 删除图片
  deleteImage(e) {
    const { index } = e.currentTarget.dataset;
    const images = [...this.data.images];
    images.splice(index, 1);
    this.setData({ images });
  },

  // 上传图片到服务器
  async uploadImages() {
    const uploadedUrls = [];
    
    for (const filePath of this.data.images) {
      if (filePath.startsWith('http')) {
        uploadedUrls.push(filePath);
        continue;
      }
      
      try {
        const res = await new Promise((resolve, reject) => {
          wx.uploadFile({
            url: api.BASE_URL + '/api/upload/image',
            filePath: filePath,
            name: 'file',
            header: {
              'Authorization': 'Bearer ' + wx.getStorageSync('token')
            },
            success: (res) => {
              const data = JSON.parse(res.data);
              if (data.code === 0) {
                resolve(data.data.url);
              } else {
                reject(new Error(data.message));
              }
            },
            fail: reject
          });
        });
        uploadedUrls.push(res);
      } catch (err) {
        console.error('Upload image error:', err);
      }
    }
    
    return uploadedUrls;
  },

  // 提交进度
  async submitProgress() {
    const { title, content, progressDate, location } = this.data.form;
    
    if (!title || !content) {
      wx.showToast({ title: '请填写完整信息', icon: 'none' });
      return;
    }

    try {
      wx.showLoading({ title: '提交中...' });
      
      // 上传图片
      const imageUrls = await this.uploadImages();
      
      // 提交进度
      await api.createProgress({
        projectId: this.data.projectId,
        title,
        content,
        progressDate,
        location,
        images: imageUrls
      });
      
      wx.showToast({ title: '提交成功', icon: 'success' });
      setTimeout(() => {
        wx.navigateBack();
      }, 1500);
    } catch (err) {
      wx.showToast({ title: '提交失败', icon: 'none' });
    } finally {
      wx.hideLoading();
    }
  }
});
```

### 5.2.4 成果提交实现

成果提交功能允许学生上传实践成果，包括调研报告、实践纪实等。

```javascript
// pages/result/detail.js
const api = require('../../utils/api');

Page({
  data: {
    projectId: null,
    form: {
      title: '',
      category: '',
      description: '',
      content: ''
    },
    coverImage: '',
    attachments: [],
    categories: ['调研报告', '实践纪实', '视频作品', '新闻稿件', '其他']
  },

  // 选择封面图
  chooseCover() {
    wx.chooseImage({
      count: 1,
      sizeType: ['compressed'],
      success: (res) => {
        this.setData({ coverImage: res.tempFilePaths[0] });
      }
    });
  },

  // 选择附件
  chooseAttachment() {
    wx.chooseMessageFile({
      count: 5,
      type: 'file',
      success: (res) => {
        const newFiles = res.tempFiles.map(file => ({
          name: file.name,
          path: file.path,
          size: file.size
        }));
        this.setData({
          attachments: [...this.data.attachments, ...newFiles]
        });
      }
    });
  },

  // 提交成果
  async submitResult() {
    const { title, category, description, content } = this.data.form;
    
    if (!title || !category) {
      wx.showToast({ title: '请填写完整信息', icon: 'none' });
      return;
    }

    try {
      wx.showLoading({ title: '提交中...' });
      
      // 上传封面图
      let coverUrl = '';
      if (this.data.coverImage) {
        coverUrl = await this.uploadFile(this.data.coverImage, 'image');
      }
      
      // 上传附件
      const attachmentUrls = [];
      for (const file of this.data.attachments) {
        const url = await this.uploadFile(file.path, 'file');
        attachmentUrls.push({
          name: file.name,
          url: url,
          size: file.size
        });
      }
      
      // 提交成果
      await api.createResult({
        projectId: this.data.projectId,
        title,
        category,
        description,
        content,
        coverUrl,
        attachments: attachmentUrls
      });
      
      wx.showToast({ title: '提交成功', icon: 'success' });
      setTimeout(() => wx.navigateBack(), 1500);
    } catch (err) {
      wx.showToast({ title: '提交失败', icon: 'none' });
    } finally {
      wx.hideLoading();
    }
  }
});
```

## 5.3 管理员端功能实现

### 5.3.1 审批管理实现

审批管理是管理员的核心功能，支持学院级和校级两级审批。

**（1）审批列表页面**

```javascript
// pages/approve/list.js
const api = require('../../utils/api');

Page({
  data: {
    projects: [],
    statusFilter: 'pending',
    statusOptions: [
      { value: 'pending', label: '待审批' },
      { value: 'college_approved', label: '学院已审' },
      { value: 'approved', label: '已通过' },
      { value: 'rejected', label: '已驳回' }
    ],
    page: 1,
    hasMore: true
  },

  onLoad() {
    this.loadProjects();
  },

  async loadProjects() {
    try {
      const app = getApp();
      const userRole = app.globalData.userInfo.role;
      
      // 根据角色确定查询的状态
      let status = this.data.statusFilter;
      if (userRole === 'school_admin' && status === 'pending') {
        status = 'college_approved'; // 校级管理员看学院已审的项目
      }
      
      const res = await api.getApprovalList({
        status,
        page: this.data.page,
        pageSize: 10
      });
      
      this.setData({
        projects: this.data.page === 1 ? res.list : [...this.data.projects, ...res.list],
        hasMore: res.list.length === 10
      });
    } catch (err) {
      wx.showToast({ title: '加载失败', icon: 'none' });
    }
  },

  // 审批通过
  async approveProject(e) {
    const { id } = e.currentTarget.dataset;
    
    wx.showModal({
      title: '确认审批',
      content: '确定通过该项目的审批吗？',
      success: async (res) => {
        if (res.confirm) {
          try {
            await api.approveProject(id, {
              action: 'approve',
              opinion: '审批通过'
            });
            wx.showToast({ title: '审批成功', icon: 'success' });
            this.setData({ page: 1 });
            this.loadProjects();
          } catch (err) {
            wx.showToast({ title: '操作失败', icon: 'none' });
          }
        }
      }
    });
  },

  // 审批驳回
  rejectProject(e) {
    const { id } = e.currentTarget.dataset;
    
    wx.navigateTo({
      url: `/pages/approve/reject?id=${id}`
    });
  }
});
```

**（2）后端审批接口**

```javascript
// routes/approval.js
router.post('/:id/approve', authMiddleware, async (req, res) => {
  try {
    const { id } = req.params;
    const { action, opinion } = req.body;
    const userId = req.user.id;
    const userRole = req.user.role;

    // 查询项目
    const [projects] = await db.query('SELECT * FROM project WHERE id = ?', [id]);
    if (projects.length === 0) {
      return error(res, '项目不存在', 404);
    }

    const project = projects[0];
    let newStatus = '';
    let approvalLevel = '';

    // 根据角色和动作确定新状态
    if (userRole === 'college_admin') {
      approvalLevel = 'college';
      if (action === 'approve') {
        newStatus = 'college_approved';
      } else {
        newStatus = 'rejected';
      }
    } else if (userRole === 'school_admin') {
      approvalLevel = 'school';
      if (action === 'approve') {
        newStatus = 'approved';
      } else {
        newStatus = 'rejected';
      }
    }

    // 更新项目状态
    await db.query(
      'UPDATE project SET status = ?, reject_reason = ? WHERE id = ?',
      [newStatus, action === 'reject' ? opinion : null, id]
    );

    // 记录审批历史
    await db.query(
      'INSERT INTO approval_record (project_id, approver_id, approval_level, action, opinion) VALUES (?, ?, ?, ?, ?)',
      [id, userId, approvalLevel, action, opinion]
    );

    success(res, null, '审批成功');
  } catch (err) {
    console.error('Approve error:', err);
    error(res, '审批失败', 500);
  }
});
```

### 5.3.2 通知发布实现

通知发布功能允许校级管理员发布活动通知和公告。

```javascript
// routes/notice.js
router.post('/', authMiddleware, async (req, res) => {
  try {
    const { title, type, content, summary, isTop } = req.body;
    const userId = req.user.id;

    // 验证权限
    if (req.user.role !== 'school_admin') {
      return error(res, '无权限发布通知', 403);
    }

    // 插入通知
    const [result] = await db.query(
      `INSERT INTO notice (title, type, content, summary, publisher_id, is_top, status, publish_time) 
       VALUES (?, ?, ?, ?, ?, ?, 'published', NOW())`,
      [title, type, content, summary, userId, isTop ? 1 : 0]
    );

    success(res, { id: result.insertId }, '发布成功');
  } catch (err) {
    console.error('Create notice error:', err);
    error(res, '发布失败', 500);
  }
});
```

## 5.4 系统关键技术实现

### 5.4.1 JWT身份认证

系统使用JWT进行身份认证，认证中间件实现如下：

```javascript
// middleware/auth.js
const jwt = require('jsonwebtoken');

const authMiddleware = (req, res, next) => {
  try {
    const authHeader = req.headers.authorization;
    
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return res.status(401).json({
        code: 401,
        message: '未授权，请先登录'
      });
    }

    const token = authHeader.substring(7);
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    
    req.user = decoded;
    next();
  } catch (err) {
    if (err.name === 'TokenExpiredError') {
      return res.status(401).json({
        code: 401,
        message: 'Token已过期，请重新登录'
      });
    }
    return res.status(401).json({
      code: 401,
      message: '无效的Token'
    });
  }
};

module.exports = authMiddleware;
```

### 5.4.2 文件上传处理

系统使用multer中间件处理文件上传：

```javascript
// routes/upload.js
const express = require('express');
const router = express.Router();
const multer = require('multer');
const path = require('path');

// 配置存储
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    const type = req.params.type || 'files';
    cb(null, path.join(__dirname, `../../uploads/${type}`));
  },
  filename: (req, file, cb) => {
    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
    const ext = path.extname(file.originalname);
    cb(null, uniqueSuffix + ext);
  }
});

const upload = multer({
  storage,
  limits: { fileSize: 10 * 1024 * 1024 }, // 10MB
  fileFilter: (req, file, cb) => {
    // 允许的文件类型
    const allowedTypes = /jpeg|jpg|png|gif|pdf|doc|docx|xls|xlsx|mp4/;
    const ext = path.extname(file.originalname).toLowerCase();
    if (allowedTypes.test(ext)) {
      cb(null, true);
    } else {
      cb(new Error('不支持的文件类型'));
    }
  }
});

// 图片上传
router.post('/image', authMiddleware, upload.single('file'), (req, res) => {
  if (!req.file) {
    return error(res, '请选择文件', 400);
  }
  
  const url = `/uploads/images/${req.file.filename}`;
  success(res, { url }, '上传成功');
});

// 文件上传
router.post('/file', authMiddleware, upload.single('file'), (req, res) => {
  if (!req.file) {
    return error(res, '请选择文件', 400);
  }
  
  const url = `/uploads/files/${req.file.filename}`;
  success(res, {
    url,
    name: req.file.originalname,
    size: req.file.size
  }, '上传成功');
});

module.exports = router;
```

### 5.4.3 统一响应封装

为保证API响应格式的一致性，封装了统一的响应工具：

```javascript
// utils/response.js
const success = (res, data = null, message = '操作成功') => {
  res.json({
    code: 0,
    message,
    data
  });
};

const error = (res, message = '操作失败', code = 400) => {
  res.status(code >= 500 ? 500 : 200).json({
    code,
    message,
    data: null
  });
};

module.exports = { success, error };
```

### 5.4.4 前端请求封装

小程序端封装了统一的请求工具：

```javascript
// utils/request.js
const BASE_URL = 'http://localhost:3000';

const request = (options) => {
  return new Promise((resolve, reject) => {
    const token = wx.getStorageSync('token');
    
    wx.request({
      url: BASE_URL + options.url,
      method: options.method || 'GET',
      data: options.data,
      header: {
        'Content-Type': 'application/json',
        'Authorization': token ? `Bearer ${token}` : ''
      },
      success: (res) => {
        if (res.data.code === 0) {
          resolve(res.data.data);
        } else if (res.data.code === 401) {
          // Token过期，跳转登录
          wx.removeStorageSync('token');
          wx.redirectTo({ url: '/pages/login/index' });
          reject(new Error('请重新登录'));
        } else {
          reject(new Error(res.data.message));
        }
      },
      fail: (err) => {
        reject(new Error('网络请求失败'));
      }
    });
  });
};

module.exports = {
  BASE_URL,
  get: (url, data) => request({ url, method: 'GET', data }),
  post: (url, data) => request({ url, method: 'POST', data }),
  put: (url, data) => request({ url, method: 'PUT', data }),
  delete: (url, data) => request({ url, method: 'DELETE', data })
};
```
