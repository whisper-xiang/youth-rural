# 第四章 系统总体设计

## 4.1 系统架构设计

### 4.1.1 总体架构

本系统采用前后端分离的B/S架构，分为表示层、业务逻辑层、数据访问层三层结构。

```
┌─────────────────────────────────────────────────────────────────┐
│                         表示层                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              微信小程序 (WXML + WXSS + JS)               │   │
│  └─────────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────────┤
│                       业务逻辑层                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │           Node.js + Express (RESTful API)               │   │
│  └─────────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────────┤
│                       数据访问层                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    MySQL 数据库                          │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

**各层职责说明：**

- **表示层**：负责用户界面展示和用户交互，使用微信小程序技术实现
- **业务逻辑层**：负责业务逻辑处理，提供RESTful API接口
- **数据访问层**：负责数据的持久化存储和访问

### 4.1.2 前端架构

小程序前端采用模块化的目录结构：

```
sxs-miniapp/
├── app.js                 # 小程序入口，全局状态管理
├── app.json               # 全局配置，页面路由
├── app.wxss               # 全局样式
├── pages/                 # 页面目录
│   ├── login/            # 登录页
│   ├── index/            # 首页
│   ├── notice/           # 通知模块
│   │   ├── list          # 通知列表
│   │   └── detail        # 通知详情
│   ├── activity/         # 项目申报模块
│   │   ├── apply-list    # 项目列表
│   │   └── apply-detail  # 项目详情/申报
│   ├── approve/          # 审批模块
│   │   ├── list          # 审批列表
│   │   └── detail        # 审批详情
│   ├── progress/         # 进度模块
│   │   ├── list          # 进度列表
│   │   └── detail        # 进度详情/上传
│   ├── result/           # 成果模块
│   │   ├── list          # 成果列表
│   │   └── detail        # 成果详情/提交
│   ├── evaluate/         # 评优模块
│   │   ├── list          # 评优列表
│   │   └── detail        # 评审详情
│   └── profile/          # 个人中心
├── utils/                # 工具函数
│   ├── api.js           # API接口封装
│   ├── request.js       # 网络请求封装
│   └── util.js          # 通用工具函数
└── images/              # 图片资源
```

### 4.1.3 后端架构

后端采用Express框架的标准目录结构：

```
sxs-admin/
├── src/
│   ├── app.js            # 应用入口
│   ├── config/           # 配置文件
│   │   └── db.js        # 数据库连接配置
│   ├── middleware/       # 中间件
│   │   └── auth.js      # JWT认证中间件
│   ├── routes/           # 路由模块
│   │   ├── auth.js      # 认证路由 (/api/auth)
│   │   ├── user.js      # 用户路由 (/api/user)
│   │   ├── project.js   # 项目路由 (/api/project)
│   │   ├── approval.js  # 审批路由 (/api/approval)
│   │   ├── progress.js  # 进度路由 (/api/progress)
│   │   ├── result.js    # 成果路由 (/api/result)
│   │   ├── evaluation.js# 评优路由 (/api/evaluation)
│   │   ├── notice.js    # 通知路由 (/api/notice)
│   │   └── upload.js    # 上传路由 (/api/upload)
│   └── utils/            # 工具函数
│       └── response.js  # 统一响应封装
├── uploads/              # 上传文件目录
├── database/             # 数据库脚本
└── .env                  # 环境变量配置
```

## 4.2 系统功能模块设计

### 4.2.1 功能模块总览

```
┌─────────────────────────────────────────────────────────────────┐
│                    三下乡活动管理系统                            │
├─────────┬─────────┬─────────┬─────────┬─────────┬─────────────┤
│ 用户认证 │ 通知公告 │ 项目申报 │ 审批管理 │ 进度跟踪 │ 成果管理   │
├─────────┼─────────┼─────────┼─────────┼─────────┼─────────────┤
│·用户登录│·通知列表│·项目列表│·审批列表│·进度列表│·成果列表   │
│·微信登录│·通知详情│·项目申报│·审批操作│·进度上传│·成果提交   │
│·账号绑定│·通知发布│·项目详情│·审批记录│·进度评论│·成果详情   │
├─────────┴─────────┴─────────┴─────────┴─────────┴─────────────┤
│                                                                 │
├─────────────────────┬───────────────────────────────────────────┤
│      评优评审        │              个人中心                     │
├─────────────────────┼───────────────────────────────────────────┤
│·评优列表            │·个人信息                                  │
│·评审打分            │·数据统计                                  │
│·评审结果            │·消息通知                                  │
└─────────────────────┴───────────────────────────────────────────┘
```

### 4.2.2 各角色功能权限

| 功能模块 | 学生 | 教师 | 学院管理员 | 校级管理员 | 评审专家 |
|---------|------|------|-----------|-----------|---------|
| 通知查看 | ✓ | ✓ | ✓ | ✓ | ✓ |
| 通知发布 | - | - | - | ✓ | - |
| 项目申报 | ✓ | - | - | - | - |
| 项目查看 | ✓ | ✓ | ✓ | ✓ | ✓ |
| 学院审批 | - | - | ✓ | - | - |
| 校级审批 | - | - | - | ✓ | - |
| 进度上传 | ✓ | - | - | - | - |
| 进度评论 | - | ✓ | - | - | - |
| 成果提交 | ✓ | - | - | - | - |
| 评审打分 | - | - | - | - | ✓ |

## 4.3 系统业务流程设计

### 4.3.1 用户登录流程

```
开始 → 打开小程序 → 检查本地Token → Token有效? 
                                      ├─ 是 → 进入首页 → 结束
                                      └─ 否 → 显示登录页
                                              ├─ 账号密码登录 → 验证账号 → 成功? 
                                              │                           ├─ 是 → 保存Token → 进入首页
                                              │                           └─ 否 → 提示错误
                                              └─ 微信登录 → 获取openid → 已绑定?
                                                                          ├─ 是 → 保存Token → 进入首页
                                                                          └─ 否 → 绑定账号 → 保存Token → 进入首页
```

### 4.3.2 项目申报流程

```
开始 → 创建项目 → 填写基本信息 → 选择指导教师 → 添加团队成员 → 上传附件
                                                                    ↓
                                                              保存/提交?
                                                              ├─ 保存 → 草稿状态 → 结束
                                                              └─ 提交 → 待审状态 → 学院审批
                                                                                    ├─ 通过 → 学院已审 → 校级审批
                                                                                    │                    ├─ 通过 → 已通过 → 结束
                                                                                    │                    └─ 驳回 → 已驳回 → 结束
                                                                                    └─ 驳回 → 已驳回 → 结束
```

### 4.3.3 项目状态流转

| 状态值 | 状态名称 | 说明 | 可执行操作 |
|-------|---------|------|-----------|
| draft | 草稿 | 项目创建后的初始状态 | 编辑、提交、删除 |
| pending | 待审批 | 已提交，等待学院审批 | 查看 |
| college_approved | 学院已审 | 学院审批通过，等待校级审批 | 查看 |
| approved | 已通过 | 校级审批通过，项目立项 | 上传进度、提交成果 |
| rejected | 已驳回 | 审批未通过 | 编辑、重新提交 |

### 4.3.4 评优评审流程

```
开始 → 创建评优活动 → 选择参评项目 → 分配评审专家 → 开始评审
                                                        ↓
                                                  专家登录系统
                                                        ↓
                                                  查看待评项目
                                                        ↓
                                                  查看项目成果
                                                        ↓
                                                  多维度评分
                                                  ├─ 创新性 (25分)
                                                  ├─ 实践性 (25分)
                                                  ├─ 效果性 (25分)
                                                  └─ 报告质量 (25分)
                                                        ↓
                                                  填写评审意见
                                                        ↓
                                                  提交评审 → 计算总分 → 生成排名 → 结束
```

## 4.4 数据库设计

### 4.4.1 数据库概念设计

系统主要实体及其关系如下：

**实体说明：**
- 用户（User）：系统的使用者，包括学生、教师、管理员、专家
- 学院（College）：用户所属的学院
- 项目（Project）：三下乡实践项目
- 审批记录（ApprovalRecord）：项目的审批历史
- 进度（Progress）：项目的进度记录
- 成果（Result）：项目的实践成果
- 通知（Notice）：系统发布的通知公告
- 评优（Evaluation）：评优活动
- 评分（EvaluationScore）：专家对项目的评分

**实体关系：**
- 用户 - 学院：多对一（一个学院有多个用户）
- 项目 - 用户：多对一（一个用户可以创建多个项目）
- 项目 - 审批记录：一对多（一个项目有多条审批记录）
- 项目 - 进度：一对多（一个项目有多条进度记录）
- 项目 - 成果：一对多（一个项目可以有多个成果）
- 评优 - 评分：一对多（一个评优活动有多条评分记录）

### 4.4.2 数据库逻辑设计

#### （1）用户表（sys_user）

| 字段名 | 类型 | 说明 | 约束 |
|-------|------|------|------|
| id | BIGINT | 用户ID | 主键，自增 |
| username | VARCHAR(50) | 用户名 | 唯一，非空 |
| password | VARCHAR(255) | 密码（加密） | 非空 |
| real_name | VARCHAR(50) | 真实姓名 | 非空 |
| phone | VARCHAR(20) | 手机号 | - |
| email | VARCHAR(100) | 邮箱 | - |
| avatar | VARCHAR(255) | 头像URL | - |
| role | VARCHAR(20) | 角色 | 非空 |
| college_id | BIGINT | 所属学院ID | 外键 |
| status | TINYINT | 状态(1启用/0禁用) | 默认1 |
| openid | VARCHAR(100) | 微信openid | - |
| created_at | DATETIME | 创建时间 | 默认当前时间 |
| updated_at | DATETIME | 更新时间 | 自动更新 |

#### （2）学院表（sys_college）

| 字段名 | 类型 | 说明 | 约束 |
|-------|------|------|------|
| id | BIGINT | 学院ID | 主键，自增 |
| name | VARCHAR(100) | 学院名称 | 非空 |
| code | VARCHAR(20) | 学院代码 | - |
| sort | INT | 排序号 | 默认0 |
| status | TINYINT | 状态 | 默认1 |
| created_at | DATETIME | 创建时间 | 默认当前时间 |

#### （3）项目表（project）

| 字段名 | 类型 | 说明 | 约束 |
|-------|------|------|------|
| id | BIGINT | 项目ID | 主键，自增 |
| project_no | VARCHAR(50) | 项目编号 | 唯一，非空 |
| title | VARCHAR(200) | 项目名称 | 非空 |
| category | VARCHAR(50) | 项目类别 | 非空 |
| description | TEXT | 项目描述 | - |
| target_area | VARCHAR(200) | 实践地点 | - |
| start_date | DATE | 开始日期 | - |
| end_date | DATE | 结束日期 | - |
| budget | DECIMAL(10,2) | 预算金额 | 默认0 |
| leader_id | BIGINT | 负责人ID | 外键，非空 |
| teacher_id | BIGINT | 指导教师ID | 外键 |
| college_id | BIGINT | 所属学院ID | 外键 |
| status | VARCHAR(20) | 项目状态 | 默认draft |
| reject_reason | VARCHAR(500) | 驳回原因 | - |
| is_excellent | TINYINT | 是否优秀 | 默认0 |
| created_at | DATETIME | 创建时间 | 默认当前时间 |
| updated_at | DATETIME | 更新时间 | 自动更新 |

#### （4）审批记录表（approval_record）

| 字段名 | 类型 | 说明 | 约束 |
|-------|------|------|------|
| id | BIGINT | 记录ID | 主键，自增 |
| project_id | BIGINT | 项目ID | 外键，非空 |
| approver_id | BIGINT | 审批人ID | 外键，非空 |
| approval_level | VARCHAR(20) | 审批级别 | 非空 |
| action | VARCHAR(20) | 审批动作 | 非空 |
| opinion | VARCHAR(500) | 审批意见 | - |
| created_at | DATETIME | 审批时间 | 默认当前时间 |

#### （5）进度表（progress）

| 字段名 | 类型 | 说明 | 约束 |
|-------|------|------|------|
| id | BIGINT | 进度ID | 主键，自增 |
| project_id | BIGINT | 项目ID | 外键，非空 |
| title | VARCHAR(200) | 进度标题 | 非空 |
| content | TEXT | 进度内容 | - |
| progress_date | DATE | 进度日期 | - |
| location | VARCHAR(200) | 活动地点 | - |
| creator_id | BIGINT | 创建人ID | 外键，非空 |
| created_at | DATETIME | 创建时间 | 默认当前时间 |

#### （6）成果表（result）

| 字段名 | 类型 | 说明 | 约束 |
|-------|------|------|------|
| id | BIGINT | 成果ID | 主键，自增 |
| project_id | BIGINT | 项目ID | 外键，非空 |
| title | VARCHAR(200) | 成果标题 | 非空 |
| category | VARCHAR(50) | 成果类别 | 非空 |
| description | TEXT | 成果描述 | - |
| cover_url | VARCHAR(500) | 封面图URL | - |
| content | TEXT | 成果正文 | - |
| creator_id | BIGINT | 创建人ID | 外键，非空 |
| view_count | INT | 浏览次数 | 默认0 |
| status | VARCHAR(20) | 状态 | 默认draft |
| created_at | DATETIME | 创建时间 | 默认当前时间 |

#### （7）通知表（notice）

| 字段名 | 类型 | 说明 | 约束 |
|-------|------|------|------|
| id | BIGINT | 通知ID | 主键，自增 |
| title | VARCHAR(200) | 通知标题 | 非空 |
| type | VARCHAR(20) | 通知类型 | 非空 |
| content | TEXT | 通知内容 | - |
| summary | VARCHAR(500) | 摘要 | - |
| publisher_id | BIGINT | 发布人ID | - |
| is_top | TINYINT | 是否置顶 | 默认0 |
| view_count | INT | 浏览次数 | 默认0 |
| status | VARCHAR(20) | 状态 | 默认draft |
| publish_time | DATETIME | 发布时间 | - |
| created_at | DATETIME | 创建时间 | 默认当前时间 |

#### （8）评分表（evaluation_score）

| 字段名 | 类型 | 说明 | 约束 |
|-------|------|------|------|
| id | BIGINT | 评分ID | 主键，自增 |
| evaluation_id | BIGINT | 评优活动ID | 外键，非空 |
| project_id | BIGINT | 项目ID | 外键，非空 |
| expert_id | BIGINT | 专家ID | 外键，非空 |
| score_innovation | DECIMAL(5,2) | 创新性得分 | 默认0 |
| score_practice | DECIMAL(5,2) | 实践性得分 | 默认0 |
| score_effect | DECIMAL(5,2) | 效果性得分 | 默认0 |
| score_report | DECIMAL(5,2) | 报告质量得分 | 默认0 |
| total_score | DECIMAL(5,2) | 总分 | 默认0 |
| comment | VARCHAR(500) | 评审意见 | - |
| created_at | DATETIME | 评分时间 | 默认当前时间 |

### 4.4.3 数据库表关系图

```
sys_college (1) ──────< (N) sys_user
                              │
                              │ (1)
                              ▼
                           (N) project ──────< (N) project_member
                              │
            ┌─────────────────┼─────────────────┐
            │                 │                 │
            ▼                 ▼                 ▼
    approval_record      progress           result
                              │                 │
                              ▼                 ▼
                      progress_image    result_attachment
                      progress_comment

evaluation (1) ──────< (N) evaluation_score
                              │
                              ▼
                          project

notice (1) ──────< (N) notice_attachment
         ──────< (N) notice_read
```
